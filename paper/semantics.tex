\begin{figure}
   \tikzset{
   no line/.style={draw=none,
     commutative diagrams/every label/.append style={/tikz/auto=false}}}
\begin{center}
{\large
   \begin{tikzcd}
        \mathbf{\mathbf{Set}}     \arrow[bend left=35]{r}[name=F]{\mathsf{Disc}}
                                  \arrow[rr, bend left=60, "\mathsf{FS}"]
      & \mathbf{\mathbf{Poset}}   \arrow[bend left=35]{l}[name=U]{|\mathit{-}|}
                                  \arrow[to path={(F) -- (U)\tikztonodes}, no line]{}{\bot}
                                  \arrow[bend left=35]{r}[name=H]{\mathsf{Sups}}
      & \mathbf{\mathbf{SemiLat}} \arrow[bend left=35]{l}[name=K]{\ms{U}}
                                  \arrow[to path={(H) -- (K)\tikztonodes}, no line]{}{\bot}
   \end{tikzcd}
}
\end{center}
  \caption{Semantic categories of Datafun}
  \label{fig:sem-cats}
\end{figure}

\begin{figure}
  \begin{center}
    \begin{tabular}{cl}
      \multicolumn{2}{c}{\textbf{Set notation}}\\
      $\U{P}$ & Underlying set of the poset $P$\\
      $\stringset$ & Set of strings\\
      $A \boxtimes B$ & Cartesian product of sets $A$, $B$\\
      $A \boxplus B$ & Disjoint union of sets $A$, $B$\\
      $A \Arr B$ & Functions from set $A$ to set $B$
      \vspace{0.5em}\\
      \multicolumn{2}{c}{\textbf{Poset and semilattice notation}}\\
      \one & One-element poset $\{\triv\}$\\
      \two & Two-element poset $\{\sff,\stt\}$, with $\sff < \stt$\\
      $\N_\le$ & The naturals $\N$, as a (totally ordered) poset\\
      $P + Q$ & Disjointly-ordered poset on disjoint union of $P,Q$\\
      $P \x Q$ & Pointwise poset on pairs of $P$s and $Q$s\\
      $P \arr Q$ & Pointwise poset on monotone maps $\cPoset(P, Q)$\\
      %% $L \lol M$ & Pointwise poset on $\cSL(L,M)$\\
      $\Disc{A}$ & Discrete poset on underlying set $A$\\
      $\Sups{P}$ & Free semilattice on a poset $P$\\
      $\FS{A}$ & Free semilattice on a set $A$; same as $\Sups{(\Disc{A})}$\\
      $\ms{U}\;{L}$ & Underlying poset of a semilattice $L$\\
      $\below{x}{P}$ &
      The sub-poset of $P$ below $x$: $\{y \in P ~|~ y \le x\}$
      %% \\ $\FM{A}{P}$ & Poset of finite maps from the set $A$ to the poset $P$
    \end{tabular}
  \end{center}

  \caption{Semantic notation}
  \label{fig:sem-notation}
\end{figure}

%% \todo{``Finite maps'' ambiguous terminology? Gibbons uses it differently, for
%%   example.}


\section{Semantics and metatheory}
\label{sec:semantics}

We give a denotational semantics for Datafun in terms of three categories
(\cSet{}, \cPoset{}, and \cSL{}) and two adjunctions between them (see Figure
\ref{fig:sem-cats}). We use nonstandard notation to avoid confusion between sets
and posets (see Figure \ref{fig:sem-notation}). We take less care to distinguish
posets and semilattices, since while a set can be partially ordered in many
ways, a poset either \emph{is} or \emph{is not} a semilattice.

\subsection{The category \cSL{}}

\cSL{} is the category of join-semilattices with least elements, which we call
simply ``semilattices''.

Directly, a semilattice is a poset $L$, with a least element $\unit$, in which
any two elements $a,b$ have a least-upper-bound $a \vee b$. From $\unit$ and
$\vee$ it follows that any finite subset $X \subseteq_{\ms{fin}} \U{L}$ has a
least upper bound, written $\bigvee X$.

A morphism $f \in \cSL(L, M)$ is a function from $\U{L}$ to $\U{M}$ satisfying:
\begin{eqnarray*}
  f(a \vee_A b) &=& f(a) \vee_B f(b)\\
  f(\unit_A) &=& \unit_B
\end{eqnarray*}

\cSL{} is a subcategory of \ms{Poset}; every \cSL{}-morphism $f$ is monotone,
since $a \le b \iff a \vee b = b$, and so from $a \le b$ we know $f(a) \vee f(b)
= f(a \vee b) = f(b)$, thus $f(a) \le f(b)$. Since it is a subcategory, we will
typically not explicitly write the forgetful functor $\mathsf{U}(L)$ which sends
semilattices to posets by forgetting the lattice structure.


\subsection{Denotation of Datafun types}
\begin{figure}
  \[\begin{array}{rcl}
  \den{A} &\in& \cPoset_0\\
  \den{\bool} &=& \two\\
  \den{\N} &=& \N_\le\\
  \den{\str} &=& \Disc{\mathbb{S}}\\
  \den{A \x B} &=& \den{A} \x \den{B}\\
  \den{A + B} &=& \den{A} + \den{B}\\
  \den{A \mto B} &=& \den{A} \arr \den{B}\\
  \den{A \uto B} &=& \Disc{\U{\den{A}}} \arr \den{B}\\
  \den{\Set{A}} &=& \FS{\U{\den{A}}}%% \\
  %% \den{\Map{A}{B}} &=& \FM{\U{\den{A}}}{\den{B}}
  %% \end{array}\]\[\begin{array}{rcl}
  \\\\
  \den{\GD}, \den{\GG} &\in& \cPoset_0\\
  \den{\cdot} &=& \one\\
  \den{\GD, x\of A} &=& \den{\GD} \x \den{A}\\
  \den{\GG{}, \m{x}\of A} &=& \den{\GG} \x \den{A}
  \end{array}\]
  \caption{Denotations of Datafun types and contexts}
  \label{fig:sem-types}
\end{figure}

Datafun types and contexts denote posets as shown in Figure \ref{fig:sem-types}.
Datafun's semilattice types denote posets which are also semilattices---and
moreover, semilattices where the least-upper-bound operator $\bigvee$ is
\emph{computable}. \todo{should this have a proof?}


%% TERM DENOTATION FIGURE
\newcommand{\fux}[2]{\Den{\vcenter{\infer{#1}{#2}}}}
%% \newcommand{\fuxn}[3]{\Den{\vcenter{\infer[\rn{#1}]{#2}{#3}}}}
\newcommand{\dg}{\;\delta\;\gamma}

\begin{figure*}
  \[\begin{array}{rcll}
  \textbf{Derivation}\;\phantom{\dg} && \textbf{Denotation}
  \vspace{.8em}\\
  \den{\J{\GD}{\GG}{e}{A}}\;\phantom{\dg} &\in&
  \U{\den{\GD}} \Arr \U{\den{\GG} \arr \den{A}}
  \vspace{.8em}\\
  \fux{\J{x_1\of A_1, ..., x_n\of A_N}{\GG}{x_i}{A_i}}{
    \phantom{.}}\dg
  &=& \pi_i\;\delta
  \vspace{.8em}\\
  \fux{\J{\GD}{\m{x}_1\of L_1, ..., \m{x}_n\of L_n}{\m{x}_i}{L_i}}{
    \phantom{.}}\dg
  &=& \pi_i\;\gamma
  \vspace{.8em}\\

  %% function rules
  \fux{\J{\GD}{\GG}{\fn\bind{x} e}{A \uto B}}{
    \J{\GD,x\of A}{\GG}{e}{B}}\dg
  &=& x \mapsto \den{e}\;\tuple{\delta,x}\;\gamma
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{\fn\bind{\m{x}} e}{A \mto B}}{
    \J{\GD}{\GG,\m{x}\of A}{e}{B}}\dg
  &=& x \mapsto \den{e} \;\delta \;\tuple{\gamma,x}
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{e_1\;e_2}{B}}{
    \J{\GD}{\GG}{e_1}{A \uto B} &
    \J{\GD}{\cdot}{e_2}{A}} \dg
  &=& \den{e_1}\dg\;(\den{e_2}\;\delta\;\triv)
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{e_1\;e_2}{B}}{
    \J{\GD}{\GG}{e_1}{A \mto B} &
    \J{\GD}{\GG}{e_2}{B}} \dg
  &=& \den{e_1}\dg\;(\den{e_2}\dg)
  \vspace{.8em}\\

  %% product types
  \fux{\J{\GD}{\GG}{(e_1, e_2)}{A_1 \x A_2}}{
    \J{\GD}{\GG}{e_i}{A_i}}\dg
  &=& \pair{\den{e_1}\dg}{\den{e_2}\dg}
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{\pi_i\;e}{A_i}}{
    \J{\GD}{\GG}{e}{A_1 + A_2}}\dg
  &=& \pi_i\;(\den{e}\dg)
  \vspace{.8em}\\

  %% sum type rules
  \fux{\J{\GD}{\GG}{\ms{in}_i\;e}{A_1 + A_2}}{
    \J{\GD}{\GG}{e}{A_i}}\dg
  &=& \ms{in}_i\;(\den{e}\dg)
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{\case{e}{x}{e_1}{x}{e_2}}{B}}{
    \J{\GD}{\cdot}{e}{A_1 + A_2} &
    \J{\GD,x\of A_i}{\GG}{e_i}{B}}
  \dg
  &=&
  \begin{cases}
    \den{e_1}\;\pair{\delta}{x}\;\gamma
    &\text{if }\den{e}\;\delta\;\triv = \ms{in}_1\;x\\
    \den{e_2}\;\pair{\delta}{x}\;\gamma
    &\text{if }\den{e}\;\delta\;\triv = \ms{in}_2\;x\\
  \end{cases}
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{\case{e}{\m{x}}{e_1}{\m{x}}{e_2}}{B}}{
    \J{\GD}{\GG}{e}{A_1 + A_2} &
    \J{\GD}{\GG,\m{x}\of A_i}{e_i}{B}
  }\dg
  &=&
  \begin{cases}
    \den{e_1}\;\delta\;\pair{\gamma}{x}
    &\text{if }\den{e} \dg = \ms{in}_1\;x\\
    \den{e_2}\;\delta\;\pair{\gamma}{x}
    &\text{if }\den{e} \dg = \ms{in}_2\;x\\
  \end{cases}
  \vspace{.8em}\\

  %% semilattice rules
  \fux{\J{\GD}{\GG}{\unit}{L}}{\phantom{.}}\dg
  &=& \unit_{\den{L}}
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{e_1 \vee e_2}{L}}{
    \J{\GD}{\GG}{e_i}{L}}\dg
  &=& \den{e_1}\dg \vee_{\den{L}} \den{e_2}\dg
  \vspace{.8em}\\

  %% set intro/elim rules
  \fux{\J{\GD}{\GG}{\singleset{e}}{\Set{A}}}{\J{\GD}{\cdot}{e}{A}}\dg
  &=& \{\den{e}\;\delta\;\triv\}
  \vspace{.8em}\\
  \fux{\J{\GD}{\GG}{\letin{x}{e_1}{e_2}}{L}}{
    \J{\GD}{\GG}{e_1}{\Set{A}} &
    \J{\GD,x\of A}{\GG}{e_2}{L}}\dg
  &=& \displaystyle\bigvee_{x ~\in~ \den{e_1}\,\delta\,\gamma}
  \den{e_2}\;\tuple{\delta,x}\;\gamma
  \vspace{.8em}\\

  %% fix rules
  \fux{\J{\GD}{\GG}{\fix{\m{x}}{e}}{\fineq{L}}}{
    \J{\GD}{\GG,\m{x}\of \fineq{L}}{e}{\fineq{L}}
  }\dg
  &=&
  \ms{lfp\ in}~{\den{\fineq{L}}} ~\ms{of}~ (\fn\bind{x} \den{e}\;\pair{\delta}{x}\;\gamma)
  \vspace{0.8em}\\
  \fux{\J{\GD}{\GG}{\fixle{\m{x}}{e_1}{e_2}}{\eq{L}}}{
    \J{\GD}{\GG}{e_1}{\eq{L}} &
    \J{\GD}{\GG,\m{x}\of \eq{L}}{e_2}{\eq{L}}}\dg
  &=& \TODO
  \end{array}\]

  \caption{Denotations of Datafun typing derivations}
  \label{fig:sem-terms}
\end{figure*}


\subsection{Denotation of Datafun terms}

In Figure \ref{fig:sem-terms} we give a denotation for typing derivations with
the following signature:
\begin{eqnarray*}
  \den{\J{\GD}{\GG}{e}{A}} &\in&
  \cSet(\U{\den{\GD}}, \cPoset(\den{\GG}, \den{A}))
  %% \\ &\in&
  %% \U{\den{\GD}} \Arr \U{\den{\GG} \arr \den{A}}
\end{eqnarray*}

Colloquially, $\J{\GD}{\GG}{e}{A}$ denotes a function from $\den{\GD} \x
\den{\GG}$ to $\den{A}$ that must be monotone in $\den{\GG}$ (but not in
$\den{\GD}$).

Our semantics requires the following lemma regarding fixed-points of monotone
functions:

\todo{TODO: lemma/theorem formatting}

\paragraph{Lemma: Fixed points in finite-height pointed posets.}
Any monotone map $f : A \to A$ on a nonempty poset $A$ of finite height with a
least element $\unit$ has a least fixed point of the form $f^n(\unit)$.

\paragraph{Proof:}
Consider the sequence $\unit, f(\unit), f^2(\unit), f^3(\unit), ...$. Note that
$\unit \le f(\unit)$, so by monotonicity of $f$ and induction $f^i(\unit) \le
f^{i+1}(\unit)$. Thus this sequence forms an ascending chain. Since $A$ is
finite-height, this chain must be finite; thus there exists $n$ such that
$f^n(\unit) = f^{n+1}(\unit)$, i.e. $f^n(\unit)$ is a fixed-point of $f$.

Now consider any fixed-point $x$ of $f$. Since $\unit \le x$, by monotonicity of
$f$, induction, and $x = f(x)$, we have $f^i(\unit) \le x$. Thus $f^n(\unit) \le
x$. Thus $f^n(\unit)$ is the least fixed point of $f$.

\paragraph{}
We will only need this lemma on semilattices.

Moreover, for bounded fixed-points $(\fixle{\m{x}}{e_1}{e_2})$, we need this
lemma:

\paragraph{Lemma:}
The denotation $\den{L}$ of any semilattice type $L$ is an \emph{all-finite}
poset: that is, any element $x \in \den{L}$ is finite-height.

%% \paragraph{Lemma 1: Existence of fixed points in posets of finite height.}
%% Any monotone map $f : A \to A$ on a nonempty poset $A$ of finite height has at
%% least one fixed point.

%% \paragraph{Lemma 2: Finding least fixed points in pointed posets.}
%% For any poset $A$ with a least element $\unit$, for any monotone map $f : A \to
%% A$, if $f$ has a fixed point $x$ of finite height\footnote{The height of an
%%   element $x$ in a poset $A$ is the height of the sub-poset $\{y \in A ~|~ y \le
%%   x\}$.}, then $f$ has a least fixed point of the form $f^n(\unit)$ for some $n
%% \in \N$.


\subsection{Metatheory of Datafun}

\todo{TODO: Proof formatting}

We have proven the following theorems:

\paragraph{Syntactic substitution} \todo{state syntactic substitution theorem}
\paragraph{Semantic substitution} \todo{state semantic substitution theorem}

\paragraph{}
\todo{TODO: future work reference? on operational semantics \& compatibility theorem?}
