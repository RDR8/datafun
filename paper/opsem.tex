\documentclass{article}

\usepackage[margin=1in]{geometry}

\usepackage{datafun}

%% ---------- New commands
\renewcommand{\land}{~\text{and}~}
\renewcommand{\lor}{~\text{or}~}

\newcommand{\widevec}[1]{\overrightarrow{#1}}


%% preorder notation
\newcommand{\ale}{\sqsubseteq}
\newcommand{\alt}{\sqsubset}
\newcommand{\aeq}{\equiv}

\newcommand{\ordle}{\ale}
\newcommand{\ordeq}{\simeq}
\newcommand{\eqposet}[1]{\ms{Eq}(#1)}
\renewcommand{\eqposet}[1]{\|{#1}\|}
\newcommand{\eqclass}[1]{[#1]}
\newcommand{\height}{\ms{height}}
\newcommand{\elemheight}[2]{\height(#2 : #1)}
%% \newcommand{\down}[1]{{\mathop{\downarrow}{#1}}}
\newcommand{\down}[2]{\mathop{\downarrow}(#2 : #1)}

\newcommand{\dom}[1]{\text{dom}(#1)}

%% type-annotated semilattice operatoins
\newcommand{\tforin}[2]{\bigvee_{#1}(#2)\ }
\newcommand{\tfix}[2]{\ms{fix}_{#1}~{#2}~\ms{is}~}
\newcommand{\tfixle}[3]{\tfix{#1}{#2 \le #3}}

\newcommand{\hole}{[\,]}

%% iteration forms, used in evalution of fix
\newcommand{\iter}[4]{\ms{iter}_{#1}({#2}; \bind{#3}#4)}
\newcommand{\iterstep}[5]{\ms{iter}_{#1}({#2}; {#3}; {\bind{#4}#5})}
\newcommand{\iterle}[5]{\ms{iter}_{{\le}#1}({#2}; {#3}; \bind{#4}{#5})}
\newcommand{\iterlestep}[6]{\ms{iter}_{{\le}#1}({#2}; {#3}; {#4}; \bind{#5}{#6})}

\newcommand{\step}{\mapsto}
\newcommand{\steps}{\step^*}
%% \newcommand{\betaeq}{\equiv_\beta}
\newcommand{\betaeq}{\leftrightarrow}

\newcommand{\disc}[1]{\square{#1}}

%% \newcommand{\lr}[2]{#1 \models #2}
%% \newcommand{\lr}[2]{#1\mathrel{|}#2}
\newcommand{\lr}[2]{#2\mathrel{|}#1}
\newcommand{\lrcx}[3]{#1 \ent \lr{#2}{#3}}
\newcommand{\commsq}[5]{\lr{#1}{{#2}, {#4} \ale {#3}, {#5}}}

%% ---------- End new commands


\begin{document}

\section{Structural operational semantics}

\[\begin{array}{rccl}
  %% expressions
  \textsf{expressions} & e
  &\bnfeq& ... \pipe \unit_L \pipe e \vee_L e \pipe \tforin{L}{x \in e} e
  \pipe \tfix{\fineq{L}}{x}{e} \pipe \tfixle{\eq{L}}{x}{e}{e}\\
  &&& \iter{\eq{A}}{e}{x}{e} \pipe \iterstep{\eq{A}}{e}{e}{x}{e}
  \pipe \iterle{\eq{A}}{e}{e}{x}{e} \pipe \iterlestep{\eq{A}}{e}{e}{e}{x}{e}\\
  &&& \setlit{\vec{v}}
  \vspace{0.5em}\\
  %% values
  \textsf{values} & v,u,w
  &\bnfeq& \fn\bind{x} e \pipe (v, v) \pipe \ms{in}_i\; v
  \pipe \ms{true} \pipe \ms{false} \pipe \setlit{\vec{v}}
  \vspace{0.5em}\\
  %% contexts
  \textsf{contexts} & C
  &\bnfeq& \hole \pipe C\;e \pipe v\;C \pipe (C, e) \pipe (v, C) \pipe \ms{in}_i\;C
  \pipe \pi_i \; C\\
  &&& C \vee_L e \pipe v \vee_L C \pipe \tforin{L}{x \in C} e\\
  &&& \ifthen{C}{e}{e} \pipe \case{C}{a}{e}{a}{e}\\
  &&& \iter{\eq{A}}{C}{x}{e} \pipe \iterstep{\eq{A}}{v}{C}{x}{e}\\
  &&& \iterle{\eq{A}}{C}{e}{x}{e} \pipe \iterle{\eq{A}}{v}{C}{x}{e}
  \pipe \iterlestep{\eq{A}}{v}{v}{C}{x}{e}
\end{array}\]

\noindent In our operational semantics we:
\begin{enumerate}
\item Assume an elaboration step which subscripts all semilattice operations
($\unit$, $\vee$, $\bigvee$, $\ms{fix}$) with their type.
\item Do not distinguish discrete from monotone variables, and write $x,y$ for
  arbitrary variables.
\item Ignore the types $\N$ and $\str$ and their corresponding expression forms.
\item Add \ms{iter}
expressions as intermediate forms ocurring in the evaluation of \ms{fix}.
\item Classify some expressions $e$ as values $v$, and add a value-form
  $\setlit{\vec{v}}$ for finite sets.
\end{enumerate}


\subsection{Equality and inequality}

First, we define judgments $v \ale v : \eq{A}$ and $v \aeq v : \eq{A}$ for use
in our operational semantics:
\begin{mathpar}
  \infer{\ms{false} \ale \ms{false} : \bool}{}
  \and
  \infer{\ms{false} \ale \ms{true} : \bool}{}
  \and
  \infer{\ms{true} \ale \ms{true} : \bool}{}
  \and
  %% rules for set inequality
  \infer[\rn{\subseteq}]
        { \setlit{\vec{v_i}} \ale \setlit{\vec{u_i}} : \Set{\eq{A}} }
        { \forall{v_i}\,\exists{u_j}\; (v_i \aeq u_j : \eq{A}) }
  \and
  \infer%% [\rn{\ale_{\x}}]
        { (v_1, u_1) \ale (v_2, u_2) : \eq{A} \x \eq{B} }
        { v_1 \ale v_2 : \eq{A} & u_1 \ale u_2 : \eq{B} }
  \and
  \infer%% [\rn{\ale_{+}}]
        { \ms{in}_i\; v \ale \ms{in}_i\; u : \eq{A}_1 + \eq{A}_2 }
        { v \ale u : \eq{A}_i }
  \and
  \infer[\rn{{\aeq}}]{v \aeq u : \eq{A}}{v \ale u : \eq{A} & u \ale v : \eq{A}}
\end{mathpar}

To use these judgments in our operational semantics, they need to be decidable;
that they are may be seen by induction on $\eq{A}$. The quantifiers in the
premise of the rule $\rn{\subseteq}$ range over finite domains, and thus pose no
issue.

%% Since they are decidable we use their negations $v \not\ale v : \eq{A}$, $v
%% \ne v : \eq{A}$ freely.

%% It is easy to see by induction on $\eq{A}$ that $v_1 \ale v_2 : \eq{A}$ is
%% transitive in $v_i$. By construction it is also antisymmetric with respect to
%% $v_1 \aeq v_2 : \eq{A}$.


\subsection{Evaluation rules}
We phrase our evaluation rules in terms of one-holed evaluation contexts $C$ and
a hole-filling operation $C[e]$ (omitted for brevity). \todo{(Who do we cite for
  this style of operational semantics?)} Only some one-holed contexts are
allowed, enforcing a call-by-value evaluation order.

%\pagebreak
\begin{mathpar}
\infer{C[e] \step C[e']}{e \step e'}
\end{mathpar}

\[
\begin{array}{ccl}
  \multicolumn{3}{c}{\textbf{$\beta$-reductions}}\\
  (\fn\bind{x}e_1) \; e_2 &\step& \sub{e_2/x} e_1\\
  \pi_i \; (v_1, v_2) &\step& v_i\\
  \case{\ms{in}_i\; v}{x}{e_1}{x}{e_2} &\step& \sub{v/x} e_i\\
  \ifthen{\ms{true}}{e_1}{e_2} &\step& e_1\\
  \ifthen{\ms{false}}{e_1}{e_2} &\step& e_2

  %% rules for unit
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\unit}\\
  \unit_2 &\step& \ms{false}\\
  \unit_{\Set{A}} &\step& \{\}\\
  \unit_{L \x M} &\step& (\unit_L, \unit_M)\\
  \unit_{A \to L} &\step& \fn\bind{x} \unit_L\\
  \unit_{A \mto L} &\step& \fn\bind{x} \unit_L

  %% rules for \vee
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\vee}\\
  \ms{false} \vee_2 v &\step& v\\
  \ms{true} \vee_2 v &\step& \ms{true}\\
  %% the rule we've all been waiting for
  \setlit{\vec{v}} \vee_{\Set{A}} \setlit{\vec{u}} &\step& \setlit{\vec{v}, \vec{u}}\\
  (v_1, v_2) \vee_{L \x M} (u_1, u_2) &\step& (v_1 \vee_L u_1, v_2 \vee_M u_2)\\
  v \vee_{A \to L} u &\step& \fn\bind{x} v\;x \vee_L u\;x\\
  v \vee_{A \mto L} u &\step& \fn\bind{x} v\;x \vee_L u\;x

  %% rules for \bigvee
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\bigvee}\\
  \tforin{L}{x \in \{\}} e &\step& \unit_L\\
  \tforin{L}{x \in \setlit{v, \vec{u}}} e
  &\step& \sub{v/x} e \vee_L \tforin{L}{x \in \setlit{\vec{u}}} e

  %% rules for \ms{fix}
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for \ms{fix} and \ms{iter}}}\\
  \tfix{\fineq{L}}{x}{e} &\step& \iter{\fineq{L}}{\unit_{\fineq{L}}}{x}{e}\\
  \iter{\eq{A}}{v}{x}{e} &\step& \iterstep{\eq{A}}{v}{\sub{v/x} e}{x}{e}\\
  \iterstep{\eq{A}}{v_1}{v_2}{x}{e}
  &\step& \begin{cases}
    v_1 & \text{if}~{v_1 \aeq v_2 : \eq{A}}\\
    \iter{\eq{A}}{v_2}{x}{e} & \text{otherwise}
  \end{cases}\\
  %% rules for fixle, iterle
  \tfixle{\eq{L}}{x}{e_\top}{e} &\step& \iterle{\eq{L}}{e_\top}{\unit_{\eq{L}}}{x}{e}\\
  \iterle{\eq{A}}{v_\top}{v}{x}{e}
  &\step& \begin{cases}
    \iterlestep{\eq{A}}{v_\top}{v}{\sub{v/x} e}{x}{e} & \text{if}~{v \ale v_\top : \eq{A}}\\
    v_\top & \text{otherwise}
  \end{cases}\\
  \iterlestep{\eq{A}}{v_\top}{v_1}{v_2}{x}{e}
  &\step& \begin{cases}
    v_1 &\text{if}~{v_1 \aeq v_2 : \eq{A}}\\
    \iterle{\eq{A}}{v_\top}{v_2}{x}{e} & \text{otherwise}
  \end{cases}
\end{array}
\]

\subsection{Properties of evaluation}

\begin{theorem}\label{thm:determinism}
  Evaluation is deterministic: if $a \step b$ and $a \step c$ then $b = c$.
\end{theorem}

\begin{theorem}\label{thm:valuesdontstep}
  Values don't step: $\forall v\, \nexists a\; (v \step a)$.
\end{theorem}

\todo{Do these need proof? They're really obvious, tedious inductions.}


\section{Preorders}

\begin{definition}
  A \emph{preorder} is a set equipped with a reflexive, transitive relation,
  conventionally written $\ale$.\footnote{Sometimes the name \emph{preorder} is
    reserved for the relation, while a preordered set is called a ``proset''. As
    a matter of convenience, we take the preorder to include the set.} We define
  additional notation $\alt$, $\aeq$ as follows:
  \begin{eqnarray*}
    x \alt y &\iff& x \ale y \land y \not\ale x\\
    x \aeq y &\iff& x \ale y \land y \ale x
  \end{eqnarray*}

  Note that every poset is a preorder.
\end{definition}

\begin{definition}
  A \emph{chain} is a totally ordered subset of a preorder, i.e. a subset
  obeying \[\forall(a, b)\ a \alt b \lor b \alt a \lor a = b \]
\end{definition}

\begin{definition}
  The \emph{height} $\height(P)$ of a preorder $P$ is the cardinality of its largest chain.
\end{definition}

%% For a preorder $P$ which is already a poset (where $\ale$ is antisymmetric),
%% $[x] = \{x\}$ and $\eqposet{P} \cong P$.

\begin{definition}
  The \emph{down-set} $\down{P}{x}$ of an element $x$ of a preorder $P$ is the
  induced preorder on $\setfor{y}{y \ale x}$.
\end{definition}

\begin{definition}
  The \emph{height} of an element $x$ of a preorder $P$ is the height of $x$'s
  down-set: \[\elemheight{P}{x} \defeq \height(\down{P}{x})\]
\end{definition}

\begin{definition}\label{def:ordinj}
  A map $f : P \to Q$ between preorders $P,Q$ is a \emph{order embedding} $f
  : P \ordle Q$ iff:
  \begin{eqnarray*}
    x \ale_P y &\iff& f(x) \ale_Q f(y)
  \end{eqnarray*}
\end{definition}

\begin{definition}\label{def:ordeq}
  Two preorders $P,Q$ are \emph{equivalent} $P \ordeq Q$ iff there exist
  order embeddings $f : P \ordle Q$ and $g : Q \ordle P$, written $f,g : P
  \ordeq Q$.
\end{definition}

%% \begin{definition}\label{def:subpre}
%%   $P$ is a subpreorder of $Q$ iff the identity map ${id}(x) = x$ serves as a
%%   order embedding ${id} : P \ale Q$.
%% \end{definition}

%% \begin{theorem}
%%   A preorder $P$ is equivalent to a subpreorder of $Q$ (definition
%%   \ref{def:eqsubpre}) iff $P$ is equivalent (definition \ref{def:ordeq}) to a
%%   subpreorder of (definition \ref{def:subpre}) the preorder $Q$.
%% \end{theorem}
%% \begin{proof}
%%   Left as an exercise to the reader. We do not make use of this theorem.
%% \end{proof}

\begin{theorem}[Height is monotone in order embedding]\label{thm:height-le}
  If $f : P \ale Q$ then $\height(P) \le \height(Q)$.
\end{theorem}
\begin{proof}
  For any chain $C$ of $P$, $\setfor{f(x)}{x \in C}$ forms a chain in $Q$ of
  equal cardinality, as is verified easily by the definitions of order
  embeddings and chains.
\end{proof}

\begin{theorem}[Element height is monotone in order embedding]
  \label{thm:elemheight-le}
  If $f : P \ordle Q$, then $\elemheight{P}{x} \le \elemheight{Q}{f(x)}$.
\end{theorem}
\begin{proof}
  For any chain $C$ of $\down{P}{x}$, $\setfor{f(y)}{y \in C}$ forms a chain in
  $\down{Q}{f(x)}$ of equal cardinality.
\end{proof}

\begin{theorem}
  If $f,g : P \ordeq Q$, then $\elemheight{P}{x} = \elemheight{Q}{f(x)}$.
\end{theorem}
\begin{proof}
  By theorem \ref{thm:elemheight-le}, $\elemheight{P}{x} \le
  \elemheight{Q}{f(x)}$. Likewise:
  \[
  \begin{array}{rcll}
    \elemheight{Q}{f(x)}
    &\le& \elemheight{P}{g(f(x))} & \text{by theorem \ref{thm:elemheight-le}}\\
    &=& \height(\down{P}{g(f(x))}) & \text{by definition}\\
    &=& \height(\down{P}{x})
    & \text{since}~x \equiv g(f(x))~\text{by definition of}~f,g : P \ordeq Q\\
    &=& \elemheight{P}{x} & \text{by definition}
  \end{array}
  \]
\end{proof}

\todo{TODO: find and fix all references to thm:height and thm:height-elem}

\begin{definition}
  The \emph{equivalence poset} $\eqposet{P}$ of a preorder $P$ is the poset of
  its equivalence classes $\eqclass{x}$:
  \begin{eqnarray*}
    \eqclass{x}  &\defeq&  \setfor{y \in P}{x \aeq y}\\
    \eqclass{x} \le \eqclass{y} &\iff& x \ale y
  \end{eqnarray*}
\end{definition}

\begin{theorem}[Equivalence of equivalence posets]
  For any preorder $P$, $P \ordeq \eqposet{P}$.
\end{theorem}
\begin{proof}
  We pick $f,g : P \ordeq \eqposet{P}$ as follows. Let $f(x) = \eqclass{x}$.
  Then (using the axiom of choice) pick a representative $x$ of each equivalence
  class $\eqclass{x}$ and let $g(\eqclass{x}) = x$. Then clearly:
  \begin{eqnarray*}
    x \ale y &\iff& \eqclass{x} \le \eqclass{y}
  \end{eqnarray*}
  which establishes that $f,g : P \ordeq \eqposet{P}$ as desired.
\end{proof}

%% \begin{theorem}[Heights of equivalence posets]\label{thm:height}
%%   For any preorder $P$, $\height(P) = \height(\eqposet{P})$.
%% \end{theorem}
%% \begin{proof}
%%   For any chain $C$ of a preorder $P$, $\setfor{\eqclass{x}}{x \in C}$ forms a
%%   chain in $\eqposet{P}$ of equal cardinality (since for no two distinct $x,y
%%   \in C$ does $x \aeq y$); likewise, for any chain in $\eqposet{P}$ there is a
%%   chain in $P$ of equal cardinality formed by choosing a representative of each
%%   equivalence class.
%% \end{proof}

%% \begin{theorem}[Heights of elements of equivalence posets]\label{thm:height-elem}
%%   For any preorder $P$, $\elemheight{P}{x} =
%%   \elemheight{\eqposet{P}}{\eqclass{x}}$.
%% \end{theorem}
%% \begin{proof}
%%   For any chain $C$ of $\down{P}{x}$, $\setfor{\eqclass{x}}{x \in C}$ forms a
%%   chain in $\down{\eqposet{P}}{\eqclass{x}}$ of equal cardinality (since for no
%%   two distinct $a,b \in C$ does $a \equiv b$). Likewise, for any chain $C$ in
%%   $\down{\eqposet{P}}{\eqclass{x}}$ there is (at least one) chain $C'$ in
%%   $\down{P}{x}$ of equal cardinality formed by choosing a representative of each
%%   equivalence class: $C' = \setfor{a}{\eqclass{a} \in C}$. (We are guaranteed
%%   that if $\eqclass{a} \in \down{\eqposet{P}}{\eqclass{x}}$ then $a \ale x$ and
%%   therefore $a \in \down{P}{x}$.)
%% \end{proof}

%% While the proofs of theorems \ref{thm:height-le} and \ref{thm:elemheight-le}
%% use the axiom of choice (to choose representatives of each of a set of
%% equivalence classes) in the general case, in what follows we care only whether
%% given preorders or their elements have \emph{finite} height. It is left as an
%% exercise for the reader to show that the axiom of choice is unnecessary in this
%% case.


\section{POPEs}

\begin{definition}
  A set of pairs $A$ is \emph{partially reflexive} iff
  \[ (a,b) \in A \implies (a,a) \in A \wedge (b,b) \in A \]
\end{definition}

\begin{definition}
  A set of pairs $A$ is \emph{transitive} iff
  \[ (a,b) \in A \wedge (b,c) \in A \implies (a,c) \in A\]
\end{definition}

We use the term ``set of pairs'' rather than ``relation'' to emphasize that
these properties hold of the set itself, rather than the set in relation to some
underlying domain. By contrast, whether a relation is \emph{reflexive} depends
on the domain the quantifier ranges over in the proposition $\forall a.\; (a,a)
\in A$. For example, the set $\{(0,0)\}$ is partially reflexive, but the
relation $\{(0,0)\}$ is reflexive only with respect to the domain $\{0\}$, and
not on the domain $\N$.

\begin{definition}
  A \emph{partially ordered partial equivalence}, or POPE, is a partially
  reflexive and transitive set of pairs.
\end{definition}

The name ``partially ordered partial equivalence'' is meant to suggest a
connection to partial equivalence relations (PERs). Indeed, a POPE may be seen
precisely as a PER equipped with a partial order over its equivalence classes,
but we will not prove this here.

\begin{definition}
  The \emph{domain} $\dom{A}$ of a POPE is defined by:
  \begin{equation*}
    \dom{A} \defeq \setfor{a}{(a,a) \in A}
  \end{equation*}
\end{definition}

Now, note that POPEs correspond exactly to preorders: to a POPE $A$ corresponds
the set $\dom{A}$ ordered by $a \ale b \iff (a,b) \in A$. Likewise, to a
preorder $\tuple{A,\ale}$ corresponds the set $\setfor{(a,b)}{a \ale b}$.


\section{Logical relations}

Because it simplifies our logical relations and proofs, we will introduce an
additional pseudo-type $\disc{A}$, representing the poset $A$ with its ordering
replaced by the \emph{discrete} partial order, $x \le y \iff x = y$.
\[\begin{array}{rccl}
  \text{types} &
  A &\bnfeq& ... \pipe \disc{A}
\end{array}\]

Observe that under this interpretation $A \uto B$ is effectively $\disc{A} \mto
B$. In particular, if we let $\den{\disc{A}} = \Disc{|\den{A}|}$ then $\den{A
  \uto B} = \Disc{|\den{A}|} \arr \den{B} = \den{\disc{A} \mto B}$.

Let $a,b,c$ range over closed expressions%% , and let $\ms{Term}$ be the set
%% of all closed expressions
. Let $\gamma, \sigma, \chi$ range over substitutions containing only closed
expressions, and let $\ms{Ctx}(\GG)$ be the set of all substitutions of closed
expressions for the variables in $\GG$.

We define the following relations:
\[\begin{array}{ccll}
    \lr{A}{a \ale b}  && \text{definition given below}\\
    \lr{\GG}{\gamma \ale \sigma}
    &\iff& \forall(x \of A \in \GG)\ \lr{A}{\gamma(x) \ale \sigma(x)}
    & (\text{for}~\gamma,\sigma \in \ms{Ctx}(\GG))\\
    \lrcx{\GG}{A}{e_1 \ale e_2}
    &\iff& \forall(\lr{\GG}{\gamma_1 \ale \gamma_2})\
    \commsq{A}{\gamma_1}{\gamma_2}{e_1}{e_2}\\
    \commsq{A}{\gamma_1}{\gamma_2}{e_1}{e_2}
    &\iff& \forall(i = 1,2)\ \lr{A}{\gamma_i(e_1) \ale \gamma_i(e_2)}
    \land \lr{A}{\gamma_1(e_i) \ale \gamma_2(e_i)}
\end{array}\]

Note that $\commsq{A}{\gamma_1}{\gamma_2}{e_1}{e_2}$ can be seen as a commuting
square (although we have not yet shown that these relations are transitive and
therefore commute):
\begin{center}
  \tikzset{
    no line/.style={draw=none,
      commutative diagrams/every label/.append style={/tikz/auto=false}}}
  {\large
    \begin{tikzcd}
      \gamma_1(e_1) \arrow{r}{\ale} \arrow{d}{\ale}
      & \gamma_1(e_2) \arrow{d}{\ale}\\
      \gamma_2(e_1) \arrow{r}{\ale}
      & \gamma_2(e_2)
    \end{tikzcd}
  }
\end{center}

As a matter of notation, for any relation $\lr{X}{Y \ale Z}$, we write:
\[\begin{array}{ccl}
  \lr{X}{Y \aeq Z} &\iff& \lr{X}{Y \ale Z} \land \lr{X}{Z \ale Y}\\
  \lr{X}{Y}     &\iff& \lr{X}{Y \ale Y}
\end{array}\]

We now give the definition of $\lr{A}{a \ale b}$ by induction on $A$:
\[\begin{array}{ccl}
  %% discreteness comonad
  \lr{\disc{A}}{a \ale b} &\iff& \lr{A}{a \aeq b}\\
  %% booleans
  \lr{\bool}{a \ale b} &\iff&
  a \steps v \land b \steps u \land v \ale u : \bool\\
  %% sets
  \lr{\Set{A}}{a \ale b} &\iff&
  a \steps \setlit{\vec{v_i}} \land b \steps \setlit{\vec{u_i}}
  \land \forall v_i\,\exists u_j\; (\lr{A}{v_i \aeq u_j})\\
  %% sums
  \lr{A_1 + A_2}{a \ale b} &\iff&
  a \steps \ms{in}_i\;v \land b \steps \ms{in}_i\;u \land \lr{A_i}{v \ale u}\\
  %% products
  \lr{A_1 \x A_2}{a \ale b} &\iff&
  a \steps (v_1, v_2) \land b \steps (u_1, u_2)
  \land \forall i\; (\lr{A_i}{v_i \ale u_i})\\
  %% discrete functions
  \lr{A \to B}{a \ale b} &\iff& \lr{\disc{A} \mto B}{a \ale b}\\
  %% monotone functions
  \lr{A \mto B}{a \ale b} &\iff&
  a \steps \fn\bind{x} e_1 \land b \steps \fn\bind{x} e_2
  \land (\lrcx{x\of A}{B}{e_1 \ale e_2})
\end{array}\]

By definition, $\lr{A \uto B}{a \ale b} \iff \lr{\disc{A} \mto B}{a \ale b}$;
because of this, in the proofs to follow we usually omit the case for $A \uto B$
and consider only $\disc{A}$ and $A \mto B$ separately.


\subsection{Immediate properties}

\begin{theorem}[Termination]\label{thm:termination}
  If $\lr{A}{a}$ then $a \steps v$.
\end{theorem}

\begin{proof}
  By induction on $A$ and the definition of $\lr{A}{a \ale a}$.
\end{proof}

\begin{theorem}[Agreement on values of eqtypes]
  \label{thm:agree-ineq}
  $v \ale u : \eq{A}$ if and only if $\lr{\eq{A}}{v \ale u}$.
\end{theorem}

\begin{proof}
  Observe that their definitions coincide aside from the $v \steps v'$, $u
  \steps u'$ conditions in $\lr{\eq{A}}{v \ale u}$; since values don't step, $v
  \steps v' \iff v = v'$, and these conditions are trivial.
\end{proof}

%% \begin{proof}
%%   By induction on $\eq{A}$.
%%   \begin{description}
%%   \item[Case $\bool$] If $v \ale u : \bool$ then $v \steps v$ and $u \steps u$
%%     and thus $\lr{\bool}{v \ale u}$.
    
%%     If $\lr{\bool}{v \ale u}$ then $v \steps v'$ and $u \steps u'$ such that $v'
%%     \ale u' : \bool$. Since values do not step, $v = v'$ and $u = u'$ and so $v
%%     \ale u : \bool$.
    
%%   \item[Case $\eq{A}_1 \x \eq{A}_2$] If $v \ale u : \eq{A}_1 \x \eq{A}_2$ then by
%%     inversion of $\rn{\ale_{\x}}$, $v = (v_1, v_2)$ and $u = (u_1, u_2)$ such
%%     that $v_i \ale u_i : \eq{A}_i$.
    
%%   \item[Case $\eq{A} + \eq{B}$] By inductive hypothesis.
    
%%   \item[Case $\Set{\eq{A}}$] \TODO
%%   \end{description}
%% \end{proof}


\subsection{Partial reflexivity}
\begin{theorem}[Partial reflexivity]\label{thm:prefl}
  If $\lr{A}{a \ale b}$ then $\lr{A}{a \ale a}$ and $\lr{A}{b \ale b}$.
  (Equivalently, $\lr{A}{a}$ and $\lr{A}{b}$.)
\end{theorem}

\begin{proof}
  By induction on $A$.
  \begin{description}
  \item[Case $\disc{A}$] From $\lr{\disc{A}}{a \ale b}$ we have $\lr{A}{a \aeq
    b}$ and so $\lr{A}{a \ale b}$. By IH $\lr{A}{a \ale a}$, so $\lr{A}{a \aeq
    a}$, so $\lr{\disc{A}}{a}$. Argument for $\lr{\disc{A}}{b \ale b}$ is
    symmetric.

  \item[Case $\bool$] By reflexivity of $v \ale u : \bool$ on
    $\{\ms{true},\ms{false}\}$.

  \item[Case $\Set{A}$] From $\lr{A}{a \ale b}$ we have $a \steps
    \setlit{\vec{v_i}}$. It STS that $\forall v_i\, \exists v_j\; (\lr{A}{v_i
      \aeq v_j})$. By the IH, let $v_j = v_i$ and we are done. Argument for
    $\lr{\Set{A}}{b \ale b}$ is symmetric.

  \item[Case $A \x B$] By IH, applied pointwise. \todo{flesh out}
  \item[Case $A + B$] By IH. \todo{flesh out}
  \item[Case $A \uto B$] Follows from cases for $\disc{A}$ and $A \mto B$.

  \item[Case $A \mto B$] From $\lr{A \mto B}{a \ale b}$ we have $a \steps
    \fn\bind{x} e$ and $b \steps \fn\bind{x} e'$. Consider any $\gamma_1,
    \gamma_2 \in \ms{Ctx}(x \of A)$ such that $\lr{x\of A}{\gamma_1 \ale
      \gamma_2}$. Then applying $\lr{A \mto B}{a \ale b}$ we have:
    \begin{itemize}
    \item $\lr{B}{\gamma_1(e) \ale \gamma_2(e)}$ and $\lr{B}{\gamma_1(e') \ale
      \gamma_2(e')}$;
    \item $\lr{B}{\gamma_i(e) \ale \gamma_i(e')}$, and so by our IH at $B$ we
      have $\lr{B}{\gamma_i(e) \ale \gamma_i(e)}$ and $\lr{B}{\gamma_i(e') \ale
        \gamma_i(e')}$
    \end{itemize}
    which form the commuting squares $\commsq{B}{\gamma_1}{\gamma_2}{e}{e}$ and
    $\commsq{B}{\gamma_1}{\gamma_2}{e'}{e'}$ we needed.
  \end{description}
\end{proof}


\subsection{Transitivity}
\begin{theorem}[Transitivity]\label{thm:trans}
  If $\lr{A}{a \ale b}$ and $\lr{A}{b \ale c}$ then $\lr{A}{a \ale c}$.
\end{theorem}

\begin{proof}
  By induction on $A$.
  \begin{description}
    \item[Case $\disc A$] By IH, noting that if $\lr{A}{a \ale b}$ is transitive
      so is $\lr{A}{a \aeq b}$.
    \item[Case $\bool$] Trivial by transitivity of $v \ale u : \bool$.
    \item[Case $\Set{A}$] We have $a \steps \setlit{\vec{u_i}}$, $b \steps
      \setlit{\vec{v_i}}$, and $c \steps \setlit{\vec{w_i}}$. We wish to show
      $\forall u_i\, \exists w_k\, (\lr{A}{u_i \aeq w_k})$. Consider any $u_i$.
      Then $\exists v_j\, (\lr{A}{u_i \aeq v_j})$. Then $\exists w_k\,
      (\lr{A}{v_j \aeq w_k})$. Thus by IH $\lr{A}{u_i \aeq w_k}$.
    \item[Case $A \x B$] By IH, applied pointwise. \todo{flesh out}
    \item[Case $A + B$] By IH. \todo{flesh out}
    \item[Case $A \to B$] Follows from cases for $\disc{A}$ and $A \mto B$.

    \item[Case $A \mto B$] We have $a \steps \fn\bind{x}e_1$, $b \steps
      \fn\bind{x}e_2$, and $c \steps \fn\bind{x}e_3$. We have $\lrcx{x \of
        A}{B}{e_1 \ale e_2}$ and $\lrcx{x \of A}{B}{e_2 \ale e_3}$, and we wish to
      show that $\lrcx{x\of A}{B}{e_1 \ale e_3}$.

      Consider any $\gamma_1, \gamma_2 \in \ms{Ctx}(x \of A)$ such that $\lr{x
        \of A}{\gamma_1 \ale \gamma_2}$. Then the following diagram commutes by
      the transitivity of $\lr{B}{a \ale b}$ (which follows from IH):
      \todo{insert diagram}
  \end{description}
\end{proof}


\subsection{Congruence over $\step$}

Let $a \betaeq b$ be the equivalence closure of $\step$.

\begin{theorem}\label{thm:congbeta}
  If $\lr{A}{a}$ and $a \betaeq b$ then $\lr{A}{a \aeq b}$.
\end{theorem}

This follows from transitivity and the following two
lemmas:

\begin{lemma}
  If $\lr{A}{b}$ and $a \step b$ then $\lr{A}{a \aeq b}$.
\end{lemma}

\begin{proof}
  By induction on $A$, precomposing $a \step b$ with $\steps$ in each case of
  the definition of $\lr{A}{b \ale b}$.
\end{proof}

\begin{lemma}
  If $\lr{A}{a}$ and $a \step b$ then $\lr{A}{a \aeq b}$.
\end{lemma}

\begin{proof}
  By induction on $A$ and the definition of $\lr{A}{a \aeq b}$, noting by
  theorems \ref{thm:determinism} and \ref{thm:valuesdontstep} that $a \step b$
  is (1) deterministic in $a$ and (2) values never step; and that therefore if
  $a \step b$ and $a \steps v$ then $b \steps v$.
\end{proof}


\subsection{Preorder properties}

\todo{Do I really want to only consider values?}

\newcommand{\Val}[1]{\ms{V}[#1]}

\begin{definition}
  Let $\Val{A}$ be the preorder of values $v$ such that $\lr{A}{v}$, ordered by
  $\lr{A}{v \ale u}$. This is reflexive and transitive by theorems
  \ref{thm:prefl} and \ref{thm:trans} respectively. By theorem
  \ref{thm:agree-ineq}, for eqtypes $\eq{A}$ this coincides with values $v$ such
  that $v \ale v : \eq{A}$ ordered by $v \ale u : \eq{A}$.
\end{definition}

\begin{theorem}[Finite eqtypes are finite-height]\label{thm:finite-height}
  $\Val{\fineq{A}}$ has finite height for any $\fineq{A}$.
\end{theorem}

\begin{proof}
  Since by theorem \ref{thm:height} $\height(P) = \height(\eqposet{P})$ for any
  preorder $P$, it suffices to show that $\eqposet{\Val{\fineq{A}}}$ has finite
  cardinality (and thus finite height). We show this by induction on
  $\fineq{A}$:
  \begin{description}
  \item[Case $\bool$] $\Val{\bool} = \{\ms{false} < \ms{true}\}$ has finite
    cardinality (and thus so does $\eqposet{\Val{\bool}}$).

  \item[Case $\Set{\fineq{A}}$] All values $\lr{\Set{\fineq{A}}}{v}$ have the
    form $\setlit{\vec{v_i}}$ where $\lr{\fineq{A}}{v_i}$ (which can be seen by
    inverting the rule $\rn{\subseteq}$).

    Observe that
    \begin{eqnarray*}
      \eqclass{\setlit{\vec{v_i}}} \le_{\eqposet{\Val{\Set{\fineq{A}}}}}
      \eqclass{\setlit{\vec{u_i}}}
      &\text{iff}&
      \setlit{\vec{v_i}} \ale_{\Val{\Set{\fineq{A}}}} \setlit{\vec{u_i}}\\
      &\text{iff}&
      \setlit{\vec{v_i}} \ale \setlit{\vec{u_i}} : \Set{\fineq{A}}\\
      &\text{iff}&
      \forall v_i\, \exists u_j\, (v_i \equiv u_j : \Set{\fineq{A}})\\
      &\text{iff}&
      \forall v_i\, \exists u_j\, ([v_i] = [u_j])\\
      &\text{iff}&
      \{\widevec{[v_i]}\} \subseteq \{\widevec{[u_i]}\}
    \end{eqnarray*}
    (where the braces in $\setlit{\vec{v_i}}$, $\setlit{\vec{u_i}}$ are mere
    syntax, but $\{\widevec{[v_i]}\}$, $\{\widevec{[u_i]}\}$ are set of
    equivalence classes in $\Val{\Set{\fineq{A}}}$), and therefore
    $\eqposet{\Val{\Set{\fineq{A}}}}$ is isomorphic to
    $\Pfin(\eqposet{\Val{\fineq{A}}})$, ordered by inclusion $\subseteq$.

    By IH, $\eqposet{\Val{\fineq{A}}}$ has finite cardinality, and thus so does
    $\Pfin(\eqposet{\Val{\fineq{A}}})$.

  \item[Case $\fineq{A} \x \fineq{B}$] \TODO
  \item[Case $\fineq{A} + \fineq{B}$] \TODO
  \end{description}
\end{proof}

\begin{theorem}[Eqtype downsets are finite]
  For any $\eq{A}$, for any $v \in \Val{\eq{A}}$, $\down{\Val{\eq{A}}}{v}$ has
  finite height.
\end{theorem}

\begin{proof}
  Note that, having excluded $\N$ and $\str$, every eqtype $\eq{A}$ remaining is
  also a \emph{finite} eqtype, and therefore this theorem follows immediately
  from theorem \ref{thm:finite-height}.

  However, this is pedantry and, moreover, a swindle: what we really wish to
  show is, you may add whatever base eqtypes to Datafun you like as long as they
  satisfy the property that all their downsets are finite-height. To do this it
  suffices to prove the theorem directly, by induction on $\eq{A}$:
  \begin{description}
  \item[Case $\bool$] $\Val{\bool}$ has finite cardinality, and therefore any
    subpreorder of it has finite height.

  %% \item[Case $\N$] $\down{\Val{\N}}{n} = \{0..n\}$
  %% \item[Case $\str$] Since $\str$ has the discrete ordering,
  %% $\down{\Val{\str}}{v} = \{v\}$.

  \item[Case $\Set{\eq{A}}$] By theorem \ref{thm:height-elem} it suffices to
    show $\elemheight{\eqposet{\Val{\eq{A}}}}{\eqclass{v}}$ is finite for any
    $\lr{\Set{\eq{A}}}{v}$.

    As in the corresponding case in theorem \ref{thm:finite-height}, we note
    that $\eqposet{\Val{\Set{\eq{A}}}}$ is isomorphic to
    $\Pfin(\eqposet{\Val{\eq{A}}})$, ordered by inclusion. Since any element of
    the latter has finite height, we are done.

    %% Consider any $\lr{\Set{\eq{A}}}{\setlit{\vec{u_i}}}$. Consider any chain $C
    %% \subseteq \down{\setlit{\vec{u_i}}}$. It suffices to show that $C$ is
    %% finite.

    %% Consider the set $C' \defeq
    %% \setfor{\{\widevec{\eqclass{v_i}}\}}{\setlit{\vec{v_i}} \in C}$. By
    %% (\ref{iff:subset}), if ordered by inclusion $\subseteq$, this forms a chain
    %% in $\mc{P}(\{\widevec{\eqclass{u_i}}\})$. By (\ref{iff:subset}) and the fact
    %% that $C$ is totally ordered, no two distinct elements of $C$ can have the
    %% same equivalence classes, and so $C'$ has cardinality no smaller than $C$.
    %% Therefore, since $C'$ is finite (being a subset of
    %% $\{\widevec{\eqclass{u_i}}\}$), so is $C$.

  \item[Case $\eq{A} \x \eq{B}$] \TODO
  \item[Case $\eq{A} + \eq{B}$] \TODO
  \end{description}
\end{proof}


%%
\subsection{Interpretation into preorders and monotone functions}

%% \newcommand{\I}[1]{\ms{I}(#1)}
\newcommand{\I}[1]{\llparenthesis{#1}\rrparenthesis}
%% \newcommand{\I}[1]{[#1]}

Let $\Val{\GG}$ be the pointwise preorder over substitutions of values
$\lr{A}{v}$ for the variables $x \of A \in \GG$.

Given $\lrcx{\Gamma}{A}{e_1 \ale e_2}$, we define $\I{e_i} \in \Val{\GG} \arr
\Val{A}$, that is, $\I{e_i}$ is a monotone map between the preorders $\Val{\GG}$
into $\Val{A}$, by:
\[\begin{array}{rcll}
  \I{e_i}(\gamma) = v &\iff& \gamma(e_i) \steps v
\end{array}\]

This is justified because $\lrcx{\GG}{A}{e_1 \ale e_2}$ and theorem
\ref{thm:termination} together show such a $v$ exists and theorems
\ref{thm:determinism} and \ref{thm:valuesdontstep} together show it is unique if
it exists.

Note that monotone maps between preorders themselves form a preorder in the
usual way, and $\I{e_1} \ale \I{e_2}$ by 


\subsection{Fundamental theorem}

Now, we aim to show that every well-typed term is in the corresponding logical
relation. The most interesting case here are the \ms{fix} expressions; before we
prove this, we will need a few lemmas to help establish those cases.

\begin{lemma}
  For any $L$, $\lr{L}{\unit_L}$.
\end{lemma}
\begin{proof}
  \TODO
\end{proof}

\begin{lemma}\label{thm:iterstep}
  For any closed term $a = \iter{\fineq{L}}{v}{x}{e}$ such that $\lrcx{x \of
    \fineq{L}}{\fineq{L}}{e}$ and $\lr{\fineq{L}}{v}$, either:
  \begin{itemize}
  \item $a \step v$, or
  \item $a \steps \iter{\fineq{L}}{v'}{x}{e}$ for some $v'$ such that
    $\lr{\fineq{L}}{v \ale v'}$.
  \end{itemize}
\end{lemma}
\begin{proof}
  \TODO
\end{proof}

As a consequence of Lemma \ref{thm:iterstep}, for any such term $a =
\iter{\fineq{L}}{v_1}{x}{e}$ there is a sequence

\[ \iter{\fineq{L}}{v_1}{x}{e} \steps
\iter{\fineq{L}}{v_2}{x}{e} \steps
\iter{\fineq{L}}{v_3}{x}{e} \steps ... \]

such that either:
\begin{itemize}
\item This sequence is finite with length $n$ and $a \steps v_n$ for some
  $\lr{\fineq{L}}{v_n}$
\item This sequence is infinite; and since $\lr{\fineq{L}}{v_i \ale v_{i+1}}$,
  it forms an infinite chain in $\Val{\fineq{L}}$.
\end{itemize}

However, by Theorem \ref{thm:finite-height} the second case is impossible
($\Val{\fineq{L}}$ has finite height). Therefore:
\begin{theorem}
  If $\lrcx{x \of \fineq{L}}{\fineq{L}}{e}$ and $\lr{\fineq{L}}{v}$ then
  $\iter{\fineq{L}}{v}{x}{e} \steps v'$ where $\lr{\fineq{L}}{v'}$.
\end{theorem}


%% THE FUNDAMENTAL THEOREM
\newcommand{\cxdisc}[1]{\disc{#1}}

\begin{theorem}
  If $\J{\GD}{\GG}{e}{A}$ then $\lrcx{\cxdisc{\GD},\GG}{A}{e}$.
\end{theorem}

NB. $\cxdisc{\Delta}$ signifies the replacement of each $x \of A \in \Delta$
with $x \of \disc{A}$.

\begin{proof}
  By induction on $\J{\GD}{\GG}{e}{A}$.
  \begin{description}
  \item[Cases] $\infer[\rt{var}]{\J{\GD}{\GG}{x}{A}}{x\of A \in \GD}$,
    $\infer[\rt{var}^+]{\J{\GD}{\GG}{\m{x}}{A}}{\m{x} \of A \in \GG}$

    By definition of $\lr{\cxdisc{\GD},\GG}{\gamma_1 \ale \gamma_2}$.

    %% Boolean true, false
    \vspace{1em}
  \item[Cases] $\infer[\ms{true}]{\GD;\GG\ent \ms{true} : \bool}{}$,
    $\infer[\ms{false}]{\GD;\GG\ent \ms{false} : \bool}{}$

    Trivial.

    %% Ordinary application.
    \vspace{1em}
    \item[Case] $\infer[\rt{app}]{\J{\GD}{\GG}{e_1\;e_2}{B}}
      {\J{\GD}{\GG}{e_1}{A \uto B} & \J{\GD}{\cdot}{e_2}{A}}$

      \TODO

    %% Monotone lambda
    \vspace{1em}
  \item[Case] $\infer[\fn^+]{\GD;\GG \ent \fn\bind{\m{x}} e : A \mto B}{
    \GD; \GG{},\m{x}\of A \ent e : B}$

    TS: $\lrcx{\cxdisc{\GD},\GG}{A \mto B}{
      \fn\bind{\m{x}} e \ale \fn\bind{\m{x}}e}$.

    Consider any $\lr{\cxdisc{\GD},\GG}{\gamma_1 \ale \gamma_2}$ and any $i =
    1,2$.

    STS $\lr{A \mto B}{\fn\bind{\m{x}} \gamma_i(e) \ale \fn\bind{\m{x}}
      \gamma_i(e)}$ and $\lr{A \mto B}{\fn\bind{\m{x}} \gamma_1(e) \ale
      \fn\bind{\m{x}} \gamma_2(e)}$.

    Consider any $\lr{x \of A}{\sigma_1 \ale \sigma_2}$ and any $j = 1,2$.

    Expanding definitions, it STS:
    \begin{itemize}
    \item $\lr{B}{\sigma_j(\gamma_i(e)) \ale \sigma_j(\gamma_i(e))}$
      and $\lr{B}{\sigma_1(\gamma_i(e)) \ale \sigma_2(\gamma_i(e))}$
    \item $\lr{B}{\sigma_j(\gamma_1(e)) \ale \sigma_j(\gamma_2(e))}$
      and $\lr{B}{\sigma_1(\gamma_j(e)) \ale \sigma_2(\gamma_j(e))}$
    \end{itemize}

    All of these follow from our IH, $\lrcx{\cxdisc{\GD},\GG,x\of A}{B}{e}$,
    from partial reflexivity of $\lr{\GG}{\gamma \ale \sigma}$, and from the fact
    that if $\gamma_1 \le \gamma_2$ and $\sigma_1 \le \sigma_2$ then $\sigma_1
    \circ \gamma_1 \le \sigma_2\circ\gamma_2$.

    \todo{wrong notation above}

    %% TODO: discrete lambda

    \vspace{1em}
  \item[Case] $\infer[\ms{fix}]{\J{\GD}{\GG}{\fix{\m{x}} e}{\fineq{L}}}{
    \J{\GD}{\GG,\m{x}\of \fineq{L}}{e}{\fineq{L}}}$

    IH: $\lrcx{\cxdisc{\GD}, \GG, x \of \fineq{L}}{\fineq{L}}{e}$.

    TS: $\lrcx{\cxdisc{\GD}, \GG}{\fineq{L}}{\tfix{\fineq{L}}{x} e}$.

    %% By definition, $\tfix{\fineq{L}}{x}{e} \step
    %% \iter{\fineq{L}}{\unit_{\fineq{L}}}{x}{e}$. \todo{use lemma about $\unit$
    %%   evaluating}

    Consider any $\lr{\cxdisc{\GD},\GG}{\gamma_1 \ale \gamma_2}$.

    By Theorem \ref{thm:congbeta} it suffices to find $v_1,v_2$ such that
    $\lr{\fineq{L}}{v_1 \ale v_2}$ and $\tfix{\fineq{L}}{x} \gamma_i(e) \steps
    v_i$.

    Strategy:
    \begin{enumerate}
    \item Find sequences $a^i_j$ with elements of the form \[ a^i_j =
      \iter{\fineq{L}}{u^i_j}{x}{\gamma_i(e)}
      \]
      such that $\tfix{\fineq{L}}{x} \gamma_i(e) \steps a^i_0$ and $a^i_j \steps
      a^i_{j+1}$ and $u^i_j < u^i_{j+1} : \fineq{L}$.

    \item Prove these sequences are finite, with the final elements $a^i_n$
    \end{enumerate}

    \TODO
  \end{description}
\end{proof}

\end{document}
