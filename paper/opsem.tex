\documentclass{article}

\usepackage[margin=1in]{geometry}

\usepackage{datafun}

%% ---------- New commands
\newcommand{\hole}{[\,]}

%% type-annotated semilattice operatoins
\newcommand{\tforin}[2]{\bigvee_{#1}(#2)\ }
\newcommand{\tfix}[2]{\ms{fix}_{#1}~{#2}~\ms{is}~}
\newcommand{\tfixle}[3]{\tfix{#1}{#2 \le #3}}

%% iteration forms, used in evalution of fix
\newcommand{\iter}[4]{\ms{iter}_{#1}({#2}; \bind{#3}#4)}
\newcommand{\iterstep}[5]{\ms{iter}_{#1}({#2}; {#3}; {\bind{#4}#5})}
\newcommand{\iterle}[5]{\ms{iter}_{{\le}#1}({#2}; {#3}; \bind{#4}{#5})}
\newcommand{\iterlestep}[6]{\ms{iter}_{{\le}#1}({#2}; {#3}; {#4}; \bind{#5}{#6})}

\newcommand{\step}{\mapsto}
\newcommand{\steps}{\step^*}
%% \newcommand{\betaeq}{\equiv_\beta}
\newcommand{\betaeq}{\leftrightarrow}

\newcommand{\disc}[1]{\square{#1}}

%% \newcommand{\lr}[2]{#1 \models #2}
%% \newcommand{\lr}[2]{#1\mathrel{|}#2}
%% \newcommand{\lr}[2]{#2\mathrel{|}#1}
\newcommand{\lr}[2]{#2\mathrel{|}#1}
\newcommand{\lrcx}[3]{#1 \ent \lr{#2}{#3}}
\newcommand{\commsq}[5]{\lr{#1}{{#2}, {#4} \le {#3}, {#5}}}
\renewcommand{\land}{~\text{and}~}

%% ---------- End new commands


\begin{document}

\section{Structural operational semantics}

In our operational semantics we:
\begin{enumerate}
\item Assume an elaboration step which subscripts all semilattice operations
($\unit$, $\vee$, $\bigvee$, $\ms{fix}$) with their type.
\item Do not distinguish discrete from monotone variables, and write $x,y$ for
  arbitrary variables.
\item Ignore the types $\N$ and $\str$ and their corresponding expression forms.
\item Add \ms{iter}
expressions as intermediate forms ocurring in the evaluation of \ms{fix}.
\item Classify some expressions $e$ as values $v$, and add a value-form
  $\setlit{\vec{v}}$ for finite sets.
\end{enumerate}

\[\begin{array}{rccl}
  %% expressions
  \textsf{expressions} & e
  &\bnfeq& ... \pipe \unit_L \pipe e \vee_L e \pipe \tforin{L}{x \in e} e
  \pipe \tfix{\fineq{L}}{x}{e} \pipe \tfixle{\eq{L}}{x}{e}{e}\\
  &&& \iter{\eq{A}}{e}{x}{e} \pipe \iterstep{\eq{A}}{e}{e}{x}{e}
  \pipe \iterle{\eq{A}}{e}{e}{x}{e} \pipe \iterlestep{\eq{A}}{e}{e}{e}{x}{e}\\
  &&& \setlit{\vec{v}}
  \vspace{0.5em}\\
  %% values
  \textsf{values} & v,u,w
  &\bnfeq& \fn\bind{x} e \pipe (v, v) \pipe \ms{in}_i\; v
  \pipe \ms{true} \pipe \ms{false} \pipe \setlit{\vec{v}}
  \vspace{0.5em}\\
  %% contexts
  \textsf{contexts} & C
  &\bnfeq& \hole \pipe C\;e \pipe v\;C \pipe (C, e) \pipe (v, C) \pipe \ms{in}_i\;C
  \pipe \pi_i \; C\\
  &&& C \vee_L e \pipe v \vee_L C \pipe \tforin{L}{x \in C} e\\
  &&& \ifthen{C}{e}{e} \pipe \case{C}{a}{e}{a}{e}\\
  &&& \iter{\eq{A}}{C}{x}{e} \pipe \iterstep{\eq{A}}{v}{C}{x}{e}\\
  &&& \iterle{\eq{A}}{C}{e}{x}{e} \pipe \iterle{\eq{A}}{v}{C}{x}{e}
  \pipe \iterlestep{\eq{A}}{v}{v}{C}{x}{e}
\end{array}\]


\subsection{Equality and inequality}

\todo{Okay, I think a better way of doing this is: define a $v \le u : A$
  judgment for all types, then note that it is decidable for equality types.
  Then, define $\lr{A}{a \le b}$ as $a \steps v, b \step u, v \le u : A$.}

First, we give rules for the judgments $v \le v : \eq{A}$ and $v = v : \eq{A}$:
\begin{mathpar}
  \infer{\ms{false} \le \ms{false} : \bool}{}
  \and
  \infer{\ms{false} \le \ms{true} : \bool}{}
  \and
  \infer{\ms{true} \le \ms{true} : \bool}{}
  \and
  \infer[\rn{\le_{\x}}]{(v_1, u_1) \le (v_2, u_2) : \eq{A} \x \eq{B}}{
    v_1 \le v_2 : \eq{A} & u_1 \le u_2 : \eq{B}}
  \and
  \infer[\rn{\le_{+}}]
        { \ms{in}_i\; v \le \ms{in}_i\; u : \eq{A}_1 + \eq{A}_2 }
        { v \le u : \eq{A}_i }
  \and
  %% rules for set inequality
  \infer[\rn{\le_{\subseteq}}]
        { \setlit{\vec{v_i}} \le \setlit{\vec{u_i}} : \Set{\eq{A}} }
        { \forall{v_i}\,\exists{u_j}\; (v_i = u_j : \eq{A}) }
  \and
  \infer[\rn{{=}}]{v = u : \eq{A}}{v \le u : \eq{A} & u \le v : \eq{A}}
\end{mathpar}

To see these judgments are decidable, induct on the structure of the type
$\eq{A}$. The quantifiers in the premise of the rule $\rn{\le_{\subseteq}}$
range over finite domains, and thus pose no issue.
%% Since they are decidable we use their negations $v \not\le v : \eq{A}$, $v
%% \ne v : \eq{A}$ freely.

It is easy to see by induction on $\eq{A}$ that $v_1 \le v_2 : \eq{A}$ is
transitive in $v_i$. By construction it is also antisymmetric with respect to
$v_1 = v_2 : \eq{A}$.

%% It is also easy to show by induction on the typing judgment that for any
%% well-typed value $\vdash v : \eq{A}$, we can derive $v \le v : \eq{A}$.

%% From these it follows that $v_1 \le v_2 : \eq{A}$ forms a preorder on well-typed
%% values, and that $v_1 = v_2 : \eq{A}$ forms an equivalence relation on them.

\todo{We would like to say it is also reflexive on all well-typed values, but we
  don't have a typing judgment on values! We threw that away when we added new
  expressions to our language! Hm... but on \emph{equality types}, it should
  still work! If we need this property, should revisit this.}


\subsection{Evaluation rules}
We phrase our evaluation rules in terms of one-holed contexts $C$ and a
hole-filling operation $C[e]$ (omitted for brevity). \todo{(Who do we cite for
  this style of operational semantics?)} Only some one-holed contexts are
allowed, enforcing a call-by-value evaluation order.

%\pagebreak
\begin{mathpar}
\infer{C[e] \step C[e']}{e \step e'}
\end{mathpar}

\[
\begin{array}{ccl}
  \multicolumn{3}{c}{\textbf{$\beta$-reductions}}\\
  (\fn\bind{x}e_1) \; e_2 &\step& \sub{e_2/x} e_1\\
  \pi_i \; (v_1, v_2) &\step& v_i\\
  \case{\ms{in}_i\; v}{x}{e_1}{x}{e_2} &\step& \sub{v/x} e_i\\
  \ifthen{\ms{true}}{e_1}{e_2} &\step& e_1\\
  \ifthen{\ms{false}}{e_1}{e_2} &\step& e_2

  %% rules for unit
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\unit}\\
  \unit_2 &\step& \ms{false}\\
  \unit_{L \x M} &\step& (\unit_L, \unit_M)\\
  \unit_{A \to L} &\step& \fn\bind{x} \unit_L\\
  \unit_{A \mto L} &\step& \fn\bind{x} \unit_L\\
  \unit_{\Set{A}} &\step& \{\}

  %% rules for \vee
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\vee}\\
  \ms{false} \vee_2 v &\step& v\\
  \ms{true} \vee_2 v &\step& \ms{true}\\
  (v_1, v_2) \vee_{L \x M} (u_1, u_2) &\step& (v_1 \vee_L u_1, v_2 \vee_M u_2)\\
  v \vee_{A \to L} u &\step& \fn\bind{x} v\;x \vee_L u\;x\\
  v \vee_{A \mto L} u &\step& \fn\bind{x} v\;x \vee_L u\;x\\
  %% the rule we've all been waiting for
  \setlit{\vec{v}} \vee_{\Set{A}} \setlit{\vec{u}} &\step& \setlit{\vec{v}, \vec{u}}

  %% rules for \bigvee
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\bigvee}\\
  \tforin{L}{x \in \{\}} e &\step& \unit_L\\
  \tforin{L}{x \in \setlit{v, \vec{u}}} e
  &\step& \sub{v/x} e \vee_L \tforin{L}{x \in \setlit{\vec{u}}} e

  %% rules for \ms{fix}
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for \ms{fix} and \ms{iter}}}\\
  \tfix{\fineq{L}}{x}{e} &\step& \iter{\fineq{L}}{\unit_{\fineq{L}}}{x}{e}\\
  \iter{\eq{A}}{v}{x}{e} &\step& \iterstep{\eq{A}}{v}{\sub{v/x} e}{x}{e}\\
  \iterstep{\eq{A}}{v_1}{v_2}{x}{e}
  &\step& \begin{cases}
    v_1 & \text{if}~{v_1 = v_2 : \eq{A}}\\
    \iter{\eq{A}}{v_2}{x}{e} & \text{otherwise}
  \end{cases}\\
  %% rules for fixle, iterle
  \tfixle{\eq{L}}{x}{e_\top}{e} &\step& \iterle{\eq{L}}{e_\top}{\unit_{\eq{L}}}{x}{e}\\
  \iterle{\eq{A}}{v_\top}{v}{x}{e}
  &\step& \begin{cases}
    \iterlestep{\eq{A}}{v_\top}{v}{\sub{v/x} e}{x}{e} & \text{if}~{v \le v_\top : \eq{A}}\\
    v_\top & \text{otherwise}
  \end{cases}\\
  \iterlestep{\eq{A}}{v_\top}{v_1}{v_2}{x}{e}
  &\step& \begin{cases}
    v_1 &\text{if}~{v_1 = v_2 : \eq{A}}\\
    \iterle{\eq{A}}{v_\top}{v_2}{x}{e} & \text{otherwise}
  \end{cases}
\end{array}
\]

\subsection{Properties of evaluation}

\begin{theorem}
  Evaluation is deterministic: if $a \step b$ and $a \step c$ then $b = c$.
\end{theorem}

\begin{theorem}
  Values don't step: $\forall v\, \nexists u\; (v \step u)$.
\end{theorem}

\todo{Do these need proof? They're really obvious, tedious inductions.}


\section{Logical relations}

Let $a,b,c$ range over closed expressions%% , and let $\ms{Term}$ be the set
%% of all closed expressions
. Let $\gamma, \sigma, \chi$ range over substitutions containing only closed
expressions, and let $\ms{Ctx}(\GG)$ be the set of all substitutions of closed
expressions for the variables in $\GG$.

\todo{PROBLEM: discrete variables in contexts! Solution??: add a new ``type''
  $\disc{A}$ and replace discrete variables by variables of type $\disc{A}$?}

We define the following relations:
\[\begin{array}{ccll}
    \lr{A}{a \le b}  && \text{definition given below}\\
    \lr{\GG}{\gamma \le \sigma}
    &\iff& \forall(x\of A \in \GG)\ \lr{A}{\gamma(x) \le \sigma(x)}
    & (\text{for}~\gamma,\sigma \in \ms{Ctx}(\GG))\\
    \lrcx{\GG}{A}{e_1 \le e_2}
    &\iff& \forall(\lr{\GG}{\gamma_1 \le \gamma_2})\
    \commsq{A}{\gamma_1}{\gamma_2}{e_1}{e_2}\\
    \commsq{A}{\gamma_1}{\gamma_2}{e_1}{e_2}
    &\iff& \forall(i = 1,2)\ \lr{A}{\gamma_i(e_1) \le \gamma_i(e_2)}
    \land \lr{A}{\gamma_1(e_i) \le \gamma_2(e_i)}
\end{array}\]
Note that $\commsq{A}{\gamma_1}{\gamma_2}{e_1}{e_2}$ can be seen as a commuting
square (although we have not yet shown that these relations are transitive and
therefore commute): \todo{insert diagram}

For any relation $\lr{X}{Y \le Z}$, we write:
\[\begin{array}{ccl}
  \lr{X}{Y = Z} &\iff& \lr{X}{Y \le Z} \land \lr{X}{Z \le Y}\\
  \lr{X}{Y}     &\iff& \lr{X}{Y \le Y}
\end{array}\]

We now give the definition of $\lr{A}{a \le b}$ by induction on $A$:
\[\begin{array}{ccl}
  %% discreteness comonad
  \lr{\disc{A}}{a \le b} &\iff& \lr{A}{a = b}\\
  %% booleans
  \lr{\bool}{a \le b} &\iff&
  a \steps v \land b \steps u \land v \le u : \bool\\
  %% sums
  \lr{A_1 + A_2}{a \le b} &\iff&
  a \steps \ms{in}_i\;v \land b \steps \ms{in}_i\;u \land \lr{A_i}{v \le u}\\
  %% products
  \lr{A_1 \x A_2}{a \le b} &\iff&
  a \steps (v_1, v_2) \land b \steps (u_1, u_2)
  \land \forall i\; (\lr{A_i}{v_i \le u_i})\\
  %% sets
  \lr{\Set{A}}{a \le b} &\iff&
  a \steps \setlit{\vec{v_i}} \land b \steps \setlit{\vec{u_i}}
  \land \forall v_i\,\exists u_j\; (\lr{A}{v_i = u_j})\\
  %% discrete functions
  \lr{A \to B}{a \le b} &\iff& \lr{\disc{A} \mto B}{a \le b}\\
  %% monotone functions
  \lr{A \mto B}{a \le b} &\iff&
  a \steps \fn\bind{x} e_1 \land b \steps \fn\bind{x} e_2
  \land (\lrcx{x\of A}{B}{e_1 \le e_2})
\end{array}\]


\subsection{Termination of terms in the logical relation}

\begin{theorem}
  If $\lr{A}{a}$ then $a \steps v$.
\end{theorem}

\begin{proof}
  By induction on $A$ and the definition of $\lr{A}{a \le a}$.
\end{proof}


\subsection{Transitivity}
\begin{theorem}[Transitivity]\label{thm:trans}
  If $\lr{A}{a \le b}$ and $\lr{A}{b \le c}$ then $\lr{A}{a \le c}$.
\end{theorem}

\begin{proof}
  By induction on $A$.
  \begin{description}
    \item[Case $\bool$] Trivial by transitivity of $v \le u : \bool$.
    \item[Case $\disc A$] By IH, noting that if $\lr{A}{a \le b}$ is transitive
      so is $\lr{A}{a = b}$.
    \item[Case $A \x B$] By IH, applied pointwise. \todo{flesh out}
    \item[Case $A + B$] By IH. \todo{flesh out}
    \item[Case $\Set{A}$] We have $a \steps \setlit{\vec{u_i}}$, $b \steps
      \setlit{\vec{v_i}}$, and $c \steps \setlit{\vec{w_i}}$. We wish to show
      $\forall u_i\, \exists w_k\, (\lr{A}{u_i = w_k})$. Consider any $u_i$.
      Then $\exists v_j\, (\lr{A}{u_i = v_j})$. Then $\exists w_k\, (\lr{A}{v_j
        = w_k})$. Thus by IH $\lr{A}{u_i = w_k}$.
    \item[Case $A \to B$] Case ignored because we translate away $A \to B$.
    \item[Case $A \mto B$] We have $a \steps \fn\bind{x}e_1$, $b \steps
      \fn\bind{x}e_2$, and $c \steps \fn\bind{x}e_3$. We have $\lrcx{x \of
        A}{B}{e_1 \le e_2}$ and $\lrcx{x \of A}{B}{e_2 \le e_3}$, and we wish to
      show that $\lrcx{x\of A}{B}{e_1 \le e_3}$.

      Consider any $\gamma_1, \gamma_2 \in \ms{Ctx}(x \of A)$ such that $\lr{x
        \of A}{\gamma_1 \le \gamma_2}$. Then the following diagram commutes by
      the transitivity of $\lr{B}{a \le b}$ (which follows from IH):
      \todo{insert diagram}
  \end{description}
\end{proof}


\subsection{Partial reflexivity}
\begin{theorem}[Partial reflexivity]\label{thm:prefl}
  If $\lr{A}{a \le b}$ then $\lr{A}{a \le a}$ (and therefore $\lr{A}{a}$).
\end{theorem}

\begin{proof}
  By induction on $A$.
  \begin{description}
  \item[Case $\disc{A}$] From $\lr{\disc{A}}{a \le b}$ we have $\lr{A}{a = b}$
    and thus $\lr{A}{a \le b}$. By IH $\lr{A}{a \le a}$, and so $\lr{A}{a = a}$.
    Thus $\lr{\disc{A}}{a \le a}$.
  \item[Case $\bool$] By reflexivity of $v \le u : \bool$ on $\{\ms{true},\ms{false}\}$.
  \item[Case $A \x B$] By IH, applied pointwise. \todo{flesh out}
  \item[Case $A + B$] By IH. \todo{flesh out}
  \item[Case $A \uto B$] Ignored; we translate $A \uto B$ into $\disc{A} \mto B$.
  \item[Case $A \mto B$] From $\lr{A \mto B}{a \le b}$ we have $a \steps
    \fn\bind{x} e$ and $b \steps \fn\bind{x} e'$. Consider any $\gamma_1,
    \gamma_2 \in \ms{Ctx}(x \of A)$ such that $\lr{x\of A}{\gamma_1 \le
      \gamma_2}$. Then applying $\lr{A \mto B}{a \le b}$ we have:
    \begin{itemize}
    \item $\lr{B}{\gamma_1(e) \le \gamma_2(e)}$;
    \item $\lr{B}{\gamma_i(e) \le \gamma_i(e')}$, and so by our IH at $B$ we
      have $\lr{B}{\gamma_i(e) \le \gamma_i(e)}$
    \end{itemize}
    which form the commuting square $\commsq{B}{\gamma_1}{\gamma_2}{e}{e}$ we
    need.

  \end{description}
\end{proof}


\subsection{Congruence over $\step$}

Let $a \betaeq b$ be the equivalence closure of $\step$.

\begin{theorem}\label{thm:congbeta}
  If $\lr{A}{a}$ and $a \betaeq b$ then $\lr{A}{a = b}$.
\end{theorem}

This follows from the following two lemmas:

\begin{lemma}
  If $\lr{A}{b}$ and $a \step b$ then $\lr{A}{a = b}$.
\end{lemma}

\begin{proof}
  By induction on $A$, precomposing $a \step b$ with $\steps$ in each case of
  the definition of $\lr{A}{b \le b}$.
\end{proof}

\begin{lemma}
  If $\lr{A}{a}$ and $a \step b$ then $\lr{A}{a = b}$.
\end{lemma}

\begin{proof}
  By induction on $A$ and the definition of $\lr{A}{a = b}$, noting that $a
  \step b$ is (1) a partial function of $a$ and (2) values never step; and that
  therefore if $a \step b$ and $a \steps v$ then $b \steps v$.
\end{proof}


\subsection{Coincidence of inequality on values of equality types}

\todo{Do we need this?}

\begin{theorem}\label{thm:coincide}
  $v \le u : \eq{A}$ if and only if $\lr{\eq{A}}{v \le u}$.
\end{theorem}

\begin{proof}
  \todo{Can't we just observe that their definitions coincide aside from the $a
    \steps v$ conditions, and since values don't step this is irrelevant?}

  By induction on $\eq{A}$.
  \begin{description}
  \item[Case $\bool$] If $v \le u : \bool$ then $v \steps v$ and $u \steps u$
    and thus $\lr{\bool}{v \le u}$.

    If $\lr{\bool}{v \le u}$ then $v \steps v'$ and $u \steps u'$ such that $v'
    \le u' : \bool$. Since values do not step, $v = v'$ and $u = u'$ and so $v
    \le u : \bool$.

  \item[Case $\eq{A}_1 \x \eq{A}_2$] If $v \le u : \eq{A}_1 \x \eq{A}_2$ then by
    inversion of $\rn{\le_{\x}}$, $v = (v_1, v_2)$ and $u = (u_1, u_2)$ such
    that $v_i \le u_i : \eq{A}_i$.

  \item[Case $\eq{A} + \eq{B}$] By inductive hypothesis.

  \item[Case $\Set{\eq{A}}$] \TODO
  \end{description}
\end{proof}


\subsection{Preorder properties}

\begin{definition}
  A \emph{chain} is a totally ordered subset of a preorder.
\end{definition}

\begin{definition}
  The \emph{height} of a preorder is the cardinality of its largest chain.
\end{definition}

\newcommand{\down}[1]{{\mathop{\downarrow}{#1}}}

\begin{definition}
  The \emph{down-set} $\down{x}$ of an element $x$ of a preorder $P$ is the
  induced preorder on $\setfor{y \in P}{y \le x}$.
\end{definition}

\newcommand{\Val}[1]{\ms{Val}(#1)}

\begin{definition}
  Let $\Val{A}$ be the preorder of values $v$ such that $\lr{A}{v}$, ordered by
  $\lr{A}{v \le u}$. This is reflexive and transitive (and thus a preorder) by
  theorems \ref{thm:prefl} and \ref{thm:trans} respectively. By theorem
  \ref{thm:coincide}, for equality types $\eq{A}$ this coincides with values $v$
  such that $v \le v : \eq{A}$ ordered by $v \le u : \eq{A}$, which we will make
  use of frequently.
\end{definition}

\begin{theorem}
  $\Val{\fineq{A}}$ has finite height for any $\fineq{A}$.
\end{theorem}

\begin{proof} By induction on $\fineq{A}$:
  \begin{description}
  \item[Case $\bool$] $\Val{2} = \{\ms{false} < \ms{true}\}$ has finite
    cardinality and thus finite height.

  \item[Case $\Set{\fineq{A}}$] All values $\lr{\Set{\fineq{A}}}{v}$ have the
    form $\setlit{\vec{v_i}}$ where $\lr{\fineq{A}}{v_i}$ (which can be seen by
    inverting the rule $\rn{\le_\subseteq}$).

    \todo{Do we need to prove the height of a preorder is equal to the height of
      the poset of its equivalence classes?}

    $\lr{\fineq{A}}{\setlit{\vec{v_i}} = \setlit{\vec{u_i}}}$

    \todo{Either we observe that these are just lists quotiented by order and
      therefore are sets which have finite height, or we explicitly define a
      ``size'' function and show it must increase for $a \lt b$}

  \item[Case $\fineq{A} \x \fineq{B}$] \TODO
  \item[Case $\fineq{A} + \fineq{B}$] \TODO
  \end{description}
\end{proof}

\begin{theorem}
  For any $\eq{A}$, for any $v \in \Val{\eq{A}}$, $\down{v}$ has finite height.
\end{theorem}

\begin{proof}
  \TODO
\end{proof}


\subsection{Fundamental theorem}

\newcommand{\cxdisc}[1]{\disc{#1}}

Nb. $\cxdisc{\Delta}$ is the operation which replaces each $x \of A \in \Delta$
with $x \of \disc{A}$.

\begin{theorem}
  If $\J{\GD}{\GG}{e}{A}$ then $\lrcx{\cxdisc{\GD},\GG}{A}{e}$.
\end{theorem}

\begin{proof}
  By induction on $\J{\GD}{\GG}{e}{A}$.
  \begin{description}
  \item[Cases] $\infer[\rt{var}]{\J{\GD}{\GG}{x}{A}}{x\of A \in \GD}$,
    $\infer[\rt{var}^+]{\J{\GD}{\GG}{\m{x}}{A}}{\m{x} \of A \in \GG}$

    By definition of $\lr{\cxdisc{\GD},\GG}{\gamma_1 \le \gamma_2}$.

    %% Boolean true, false
    \vspace{1em}
  \item[Cases] $\infer[\ms{true}]{\GD;\GG\ent \ms{true} : \bool}{}$,
    $\infer[\ms{false}]{\GD;\GG\ent \ms{false} : \bool}{}$

    Trivial.

    %% Monotone lambda
    \vspace{1em}
  \item[Case] $\infer[\fn^+]{\GD;\GG \ent \fn\bind{\m{x}} e : A \mto B}{
    \GD; \GG{},\m{x}\of A \ent e : B}$

    TS: $\lrcx{\cxdisc{\GD},\GG}{A \mto B}{
      \fn\bind{\m{x}} e \le \fn\bind{\m{x}}e}$.

    Consider any $\lr{\cxdisc{\GD},\GG}{\gamma_1 \le \gamma_2}$ and any $i =
    1,2$.

    STS $\lr{A \mto B}{\fn\bind{\m{x}} \gamma_i(e) \le \fn\bind{\m{x}}
      \gamma_i(e)}$ and $\lr{A \mto B}{\fn\bind{\m{x}} \gamma_1(e) \le
      \fn\bind{\m{x}} \gamma_2(e)}$.

    Consider any $\lr{x \of A}{\sigma_1 \le \sigma_2}$ and any $j = 1,2$.

    Expanding definitions, it STS:
    \begin{itemize}
    \item $\lr{B}{\sigma_j(\gamma_i(e)) \le \sigma_j(\gamma_i(e))}$
      and $\lr{B}{\sigma_1(\gamma_i(e)) \le \sigma_2(\gamma_i(e))}$
    \item $\lr{B}{\sigma_j(\gamma_1(e)) \le \sigma_j(\gamma_2(e))}$
      and $\lr{B}{\sigma_1(\gamma_j(e)) \le \sigma_2(\gamma_j(e))}$
    \end{itemize}

    All of these follow from our IH, $\lrcx{\cxdisc{\GD},\GG,x\of A}{B}{e}$,
    from partial reflexivity of $\lr{\GG}{\gamma \le \sigma}$, and from the fact
    that if $\gamma_1 \le \gamma_2$ and $\sigma_1 \le \sigma_2$ then $\sigma_1
    \circ \gamma_1 \le \sigma_2\circ\gamma_2$.

    %% TODO: discrete lambda

    \vspace{1em}
  \item[Case] $\infer[\ms{fix}]{\J{\GD}{\GG}{\fix{\m{x}} e}{\fineq{L}}}{
    \J{\GD}{\GG,\m{x}\of \fineq{L}}{e}{\fineq{L}}}$

    IH: $\lrcx{\cxdisc{\GD}, \GG, x \of \fineq{L}}{\fineq{L}}{e}$.

    TS: $\lrcx{\cxdisc{\GD}, \GG}{\fineq{L}}{\tfix{\fineq{L}}{x} e}$.

    Consider any $\lr{\cxdisc{\GD},\GG}{\gamma_1 \le \gamma_2}$.

    By Theorem \ref{thm:congbeta} it STS $\exists v_1,v_2$ such that
    $\lr{\fineq{L}}{v_1 \le v_2}$ and $\tfix{\fineq{L}}{x} \gamma_i(e) \steps
    v_i$.

    Strategy:
    \begin{enumerate}
    \item Find sequences $a^i_j$ with elements of the form \[ a^i_j =
      \iter{\fineq{L}}{u^i_j}{x}{\gamma_i(e)}
      \]
      such that $\tfix{\fineq{L}}{x} \gamma_i(e) \steps a^i_0$ and $a^i_j \steps
      a^i_{j+1}$ and $u^i_j < u^i_{j+1} : \fineq{L}$.

    \item Prove these sequences are finite, with the final elements $a^i_n$
    \end{enumerate}

    \TODO
  \end{description}
\end{proof}

\end{document}
